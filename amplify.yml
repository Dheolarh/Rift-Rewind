version: 1
frontend:
  phases:
    preBuild:
      commands:
        - |
          # Find the frontend directory anywhere under the repository root (handles nested repo folders)
          FRONTEND_DIR=$(find "$CODEBUILD_SRC_DIR" -type d -name frontend -print -quit || true)
          if [ -n "$FRONTEND_DIR" ]; then
            echo "Found frontend at: $FRONTEND_DIR"
            cd "$FRONTEND_DIR" && npm ci
          else
            echo "frontend directory not found under $CODEBUILD_SRC_DIR"
            echo "Listing top-level contents:" && ls -la "$CODEBUILD_SRC_DIR"
            echo "Looking for directories (depth=2):" && find "$CODEBUILD_SRC_DIR" -maxdepth 2 -type d -print
            exit 1
          fi
    build:
      commands:
        - |
          # Re-resolve frontend path and build
          FRONTEND_DIR=$(find "$CODEBUILD_SRC_DIR" -type d -name frontend -print -quit || true)
          if [ -n "$FRONTEND_DIR" ]; then
            echo "Building frontend in: $FRONTEND_DIR"
            cd "$FRONTEND_DIR" && npm run build
          else
            echo "frontend directory not found under $CODEBUILD_SRC_DIR"
            echo "Listing top-level contents:" && ls -la "$CODEBUILD_SRC_DIR"
            echo "Looking for directories (depth=2):" && find "$CODEBUILD_SRC_DIR" -maxdepth 2 -type d -print
            exit 1
          fi
  artifacts:
    # The project lives in a nested folder (Rift-Rewind). Vite is configured to output to 'build', so point Amplify to that folder.
    baseDirectory: frontend/build
    files:
      - '**/*'
  cache:
    paths:
      - frontend/node_modules/**/*
